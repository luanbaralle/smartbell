<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Teste FCM SmartBell</title>
    <style>
      body {
        font-family: system-ui, -apple-system, sans-serif;
        max-width: 600px;
        margin: 40px auto;
        padding: 20px;
        background: #0f172a;
        color: #e2e8f0;
      }
      h2 {
        color: #60a5fa;
      }
      button {
        background: #2563eb;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 16px;
        margin: 10px 0;
      }
      button:hover {
        background: #1d4ed8;
      }
      #status {
        margin-top: 20px;
        padding: 12px;
        background: #1e293b;
        border-radius: 6px;
        font-family: monospace;
        font-size: 14px;
        white-space: pre-wrap;
        word-break: break-all;
      }
      .success {
        color: #22c55e;
      }
      .error {
        color: #ef4444;
      }
      .info {
        color: #60a5fa;
      }
    </style>
  </head>
  <body>
    <h2>üîî Teste FCM SmartBell</h2>
    <p>Este teste verifica se o Firebase Cloud Messaging est√° configurado corretamente.</p>
    
    <button id="enable">Ativar notifica√ß√µes</button>
    <button id="check-sw">Verificar Service Worker</button>
    
    <div id="status"></div>

    <script type="module">
      // Import Firebase libs ESM
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
      import { getMessaging, getToken, isSupported } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-messaging.js";

      const firebaseConfig = {
        apiKey: "AIzaSyCsvatTo3fk3-qBNNM_1p79RKLxPR36bd4",
        authDomain: "smartbell-cdbe1.firebaseapp.com",
        projectId: "smartbell-cdbe1",
        storageBucket: "smartbell-cdbe1.firebasestorage.app",
        messagingSenderId: "282305468523",
        appId: "1:282305468523:web:f741011c69b6b14a62392e",
        measurementId: "BF1ySQhgErYi5i7ntwDtRYAMF3c6rCvBjF4iygArr_Z3jvaEivzPN8GYsTRVRHem-9D0WJGOtkHXxXGsLK8YIaQ",
      };

      const app = initializeApp(firebaseConfig);
      const messaging = getMessaging(app);

      const statusEl = document.getElementById("status");

      function log(message, type = "info") {
        const timestamp = new Date().toLocaleTimeString();
        statusEl.innerHTML += `<span class="${type}">[${timestamp}] ${message}</span>\n`;
        statusEl.scrollTop = statusEl.scrollHeight;
        console.log(`[SmartBell] ${message}`);
      }

      // Verificar suporte
      if (!("serviceWorker" in navigator)) {
        log("‚ùå Service Workers n√£o s√£o suportados neste navegador.", "error");
      } else {
        log("‚úÖ Service Workers s√£o suportados.", "success");
      }

      // Bot√£o: Verificar Service Worker
      document.getElementById("check-sw").onclick = async () => {
        try {
          log("üîç Verificando Service Worker...", "info");
          
          const registration = await navigator.serviceWorker.getRegistration("/firebase-messaging-sw.js");
          
          if (registration) {
            log(`‚úÖ Service Worker encontrado! Escopo: ${registration.scope}`, "success");
            log(`   Estado: ${registration.active?.state || "n√£o ativo"}`, "info");
          } else {
            log("‚ö†Ô∏è Service Worker n√£o encontrado. Tente registrar primeiro.", "error");
          }
        } catch (err) {
          log(`‚ùå Erro ao verificar SW: ${err.message}`, "error");
        }
      };

      // Bot√£o: Ativar notifica√ß√µes
      document.getElementById("enable").onclick = async () => {
        try {
          log("üîî Solicitando permiss√£o de notifica√ß√µes...", "info");

          // Verificar suporte
          if (!(await isSupported())) {
            log("‚ùå Firebase Messaging n√£o √© suportado neste navegador.", "error");
            return;
          }

          const permission = await Notification.requestPermission();
          
          if (permission !== "granted") {
            log(`‚ùå Permiss√£o negada: ${permission}`, "error");
            alert("Permiss√£o negada para notifica√ß√µes.");
            return;
          }

          log("‚úÖ Permiss√£o concedida!", "success");

          // Registra o service worker do FCM
          log("üìù Registrando Service Worker...", "info");
          const registration = await navigator.serviceWorker.register("/firebase-messaging-sw.js");
          log(`‚úÖ Service Worker registrado! Escopo: ${registration.scope}`, "success");

          // Aguarda o service worker estar pronto
          await navigator.serviceWorker.ready;
          log("‚úÖ Service Worker pronto!", "success");

          // Obt√©m o token do FCM
          // NOTA: Substitua "YOUR_VAPID_KEY" pela sua VAPID key do Firebase Console
          // Voc√™ pode encontr√°-la em: Firebase Console ‚Üí Project Settings ‚Üí Cloud Messaging ‚Üí Web Push certificates
          const vapidKey = prompt(
            "Cole sua VAPID Key do Firebase:\n\n" +
            "Firebase Console ‚Üí Project Settings ‚Üí Cloud Messaging ‚Üí Web Push certificates\n\n" +
            "Ou deixe vazio para tentar sem VAPID key:"
          ) || undefined;

          if (!vapidKey) {
            log("‚ö†Ô∏è Tentando obter token sem VAPID key...", "info");
          }

          log("üîë Obtendo token FCM...", "info");
          const token = await getToken(messaging, {
            vapidKey: vapidKey,
            serviceWorkerRegistration: registration,
          });

          if (token) {
            log(`‚úÖ Token FCM gerado com sucesso!`, "success");
            log(`\nüìã Token:\n${token}\n`, "success");
            log("üí° Copie este token e salve no banco de dados (tabela users.fcm_token)", "info");
            
            // Copiar para clipboard se poss√≠vel
            if (navigator.clipboard) {
              await navigator.clipboard.writeText(token);
              log("üìã Token copiado para a √°rea de transfer√™ncia!", "success");
            }
            
            alert("Token FCM gerado! Veja o console e a √°rea de status abaixo.");
          } else {
            log("‚ùå N√£o foi poss√≠vel obter token FCM.", "error");
            alert("N√£o foi poss√≠vel obter token FCM. Verifique o console.");
          }
        } catch (err) {
          log(`‚ùå Erro ao obter token FCM: ${err.message}`, "error");
          log(`   Stack: ${err.stack}`, "error");
          alert(`Erro ao obter token FCM ‚Äî veja o console e a √°rea de status.`);
        }
      };
    </script>
  </body>
</html>

